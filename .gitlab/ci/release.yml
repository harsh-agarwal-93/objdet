# Release jobs

# Validate version bump
validate-version:
  stage: release
  extends: .base-job
  script:
    - |
      # Extract version from pyproject.toml
      VERSION=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
      echo "Current version: $VERSION"
      
      # Check if tag already exists
      if git rev-parse "v$VERSION" >/dev/null 2>&1; then
        echo "Tag v$VERSION already exists"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
        - pyproject.toml

# Generate changelog
generate-changelog:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git-cliff git
  script:
    - git fetch --tags
    - git-cliff --output CHANGELOG.md
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# Create release
create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release $CI_COMMIT_TAG"
    description: |
      ## What's Changed
      
      See [CHANGELOG.md](CHANGELOG.md) for full details.
    assets:
      links:
        - name: "Source code (tar.gz)"
          url: "${CI_PROJECT_URL}/-/archive/${CI_COMMIT_TAG}/${CI_PROJECT_NAME}-${CI_COMMIT_TAG}.tar.gz"
          link_type: package
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  needs:
    - job: generate-changelog
      optional: true

# Build and push Docker images
build-docker-train:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -f Dockerfile.train -t $CI_REGISTRY_IMAGE/train:$CI_COMMIT_TAG -t $CI_REGISTRY_IMAGE/train:latest .
    - docker push $CI_REGISTRY_IMAGE/train:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY_IMAGE/train:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

build-docker-serve:
  stage: build
  image: docker:24.0.7
  services:
    - docker:24.0.7-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -f Dockerfile.serve -t $CI_REGISTRY_IMAGE/serve:$CI_COMMIT_TAG -t $CI_REGISTRY_IMAGE/serve:latest .
    - docker push $CI_REGISTRY_IMAGE/serve:$CI_COMMIT_TAG
    - docker push $CI_REGISTRY_IMAGE/serve:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
