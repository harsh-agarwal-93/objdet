openapi: 3.0.3
info:
  title: ObjDet Backend API
  description: API for the ObjDet ML Platform backend
  version: 1.0.0
  contact:
    name: ObjDet Team

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  # Training Endpoints
  /api/training/submit:
    post:
      summary: Submit a training job
      operationId: submitTrainingJob
      tags: [Training]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TrainingConfig'
      responses:
        '200':
          description: Training job submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrainingJobResponse'

  /api/training/status/{taskId}:
    get:
      summary: Get status of a training task
      operationId: getTaskStatus
      tags: [Training]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskStatus'

  /api/training/cancel/{taskId}:
    post:
      summary: Cancel a running task
      operationId: cancelTask
      tags: [Training]
      parameters:
        - name: taskId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task cancelled

  /api/training/active:
    get:
      summary: List all active training tasks
      operationId: listActiveTasks
      tags: [Training]
      responses:
        '200':
          description: List of active tasks
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items:
                      $ref: '#/components/schemas/ActiveTask'

  # MLFlow Endpoints
  /api/mlflow/experiments:
    get:
      summary: List MLFlow experiments
      operationId: listExperiments
      tags: [MLFlow]
      responses:
        '200':
          description: List of experiments
          content:
            application/json:
              schema:
                type: object
                properties:
                  experiments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Experiment'

  /api/mlflow/runs:
    get:
      summary: List MLFlow runs
      operationId: listRuns
      tags: [MLFlow]
      parameters:
        - name: experiment_id
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
        - name: max_results
          in: query
          schema:
            type: integer
            default: 100
      responses:
        '200':
          description: List of runs
          content:
            application/json:
              schema:
                type: object
                properties:
                  runs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Run'

  /api/mlflow/runs/{runId}:
    get:
      summary: Get run details
      operationId: getRunDetails
      tags: [MLFlow]
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Run details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunDetails'

  /api/mlflow/runs/{runId}/metrics:
    get:
      summary: Get run metrics history
      operationId: getRunMetrics
      tags: [MLFlow]
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Metrics history
          content:
            application/json:
              schema:
                type: object
                properties:
                  metrics:
                    type: array
                    items:
                      $ref: '#/components/schemas/Metric'

  /api/mlflow/runs/{runId}/artifacts:
    get:
      summary: List run artifacts
      operationId: listArtifacts
      tags: [MLFlow]
      parameters:
        - name: runId
          in: path
          required: true
          schema:
            type: string
        - name: path
          in: query
          schema:
            type: string
      responses:
        '200':
          description: List of artifacts
          content:
            application/json:
              schema:
                type: object
                properties:
                  artifacts:
                    type: array
                    items:
                      $ref: '#/components/schemas/Artifact'

  # System Endpoints
  /api/system/status:
    get:
      summary: Get system status
      operationId: getSystemStatus
      tags: [System]
      responses:
        '200':
          description: System status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'

components:
  schemas:
    TrainingConfig:
      type: object
      required: [name, model_architecture, dataset, epochs]
      properties:
        name:
          type: string
          example: "YOLOv8 Training Run"
        model_architecture:
          type: string
          enum: [yolov8, yolov11, retinanet, fcos]
        dataset:
          type: string
          example: "coco2017"
        epochs:
          type: integer
          minimum: 1
          maximum: 1000
        batch_size:
          type: integer
          default: 32
        learning_rate:
          type: number
          default: 0.001
        optimizer:
          type: string
          enum: [adam, sgd, adamw]
        gpu:
          type: string
          enum: [auto, gpu0, gpu1, multi]
        mixed_precision:
          type: string
          enum: [fp16, fp32, bf16]
        save_checkpoints:
          type: boolean
          default: true
        early_stopping:
          type: boolean
          default: true
        log_to_mlflow:
          type: boolean
          default: true
        data_augmentation:
          type: boolean
          default: true

    TrainingJobResponse:
      type: object
      properties:
        task_id:
          type: string
        created_at:
          type: string
          format: date-time

    TaskStatus:
      type: object
      properties:
        task_id:
          type: string
        status:
          type: string
          enum: [pending, running, completed, failed, cancelled]
        progress:
          type: number
        current_epoch:
          type: integer
        total_epochs:
          type: integer

    ActiveTask:
      type: object
      properties:
        task_id:
          type: string
        name:
          type: string
        status:
          type: string
        progress:
          type: number
        current_epoch:
          type: integer
        total_epochs:
          type: integer

    Experiment:
      type: object
      properties:
        experiment_id:
          type: string
        name:
          type: string
        artifact_location:
          type: string

    Run:
      type: object
      properties:
        run_id:
          type: string
        run_name:
          type: string
        status:
          type: string
        experiment_id:
          type: string
        start_time:
          type: integer

    RunDetails:
      type: object
      properties:
        run_id:
          type: string
        run_name:
          type: string
        status:
          type: string
        params:
          type: object
          additionalProperties:
            type: string
        metrics:
          type: object
          additionalProperties:
            type: number

    Metric:
      type: object
      properties:
        step:
          type: integer
        metric:
          type: string
        value:
          type: number

    Artifact:
      type: object
      properties:
        path:
          type: string
        is_dir:
          type: boolean
        file_size:
          type: integer

    SystemStatus:
      type: object
      properties:
        services:
          type: object
          properties:
            celery:
              type: object
              properties:
                status:
                  type: string
                  enum: [connected, disconnected]
            mlflow:
              type: object
              properties:
                status:
                  type: string
                  enum: [connected, disconnected]
